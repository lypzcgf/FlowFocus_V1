# FlowFocus 架构设计文档

## 版本信息
- **版本号**: v1.0
- **发布日期**: 2025年9月

---

## 1. 概述

FlowFocus 是一个 Chrome 浏览器侧边栏插件，旨在帮助用户通过 AI 技术改写网页内容，提升工作效率。本文档详细描述了插件的技术架构、模块划分、数据流和实现细节。

### 1.1 技术栈

- **前端**: 原生 JavaScript + HTML + CSS
- **构建工具**: Webpack
- **存储**: Chrome Storage API
- **AI 模型**: 支持 Qwen、DeepSeek 等主流大模型

### 1.2 项目结构

```
FlowFocus_V1/
├── dist/                    # 构建输出目录
├── src/                     # 源代码目录
│   ├── sidebar/             # 侧边栏相关代码
│   │   ├── html/            # HTML 模板
│   │   ├── css/             # 样式文件
│   │   └── js/              # JavaScript 逻辑
│   ├── background/          # 后台服务
│   ├── content/             # 内容脚本
│   ├── services/            # 服务层
│   └── utils/               # 工具函数
├── icons/                   # 插件图标
├── manifest.json            # 插件配置文件
├── FlowFocus需求分析.MD     # 需求文档
└── FlowFocus架构设计.MD     # 架构设计文档
```

---

## 2. 架构设计

### 2.1 整体架构

FlowFocus 插件采用模块化设计，主要由以下几个核心部分组成：

```
┌─────────────────────────────────────────────────────────────┐
│                    Chrome 浏览器界面                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   侧边栏 (Sidebar)                     │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │  功能切换区域 (标签页)                              │ │ │
│  │  ├─────────────────────────────────────────────────────┤ │ │
│  │  │  大模型配置标签页                                   │ │ │
│  │  ├─────────────────────────────────────────────────────┤ │ │
│  │  │  改写功能标签页                                     │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   后台服务 (Background)                 │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │  大模型服务                                         │ │ │
│  │  ├─────────────────────────────────────────────────────┤ │ │
│  │  │  存储服务                                           │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据流设计

```
用户操作 → 前端界面 → 服务层 → API调用 → 数据存储
    ↓
结果反馈 ← 界面更新 ← 数据处理 ← API响应 ← 外部服务
```

---

## 3. 模块设计

### 3.1 前端模块

#### 3.1.1 Sidebar 模块

##### 大模型配置标签页
- **功能**: 管理大模型配置信息
- **核心方法**:
  - `saveModelConfig()`: 保存模型配置
  - `testModelConnection()`: 测试模型连接
  - `editModelConfig()`: 编辑模型配置
  - `deleteModelConfig()`: 删除模型配置
  - `loadModelConfigs()`: 加载所有模型配置

##### 改写功能标签页
- **功能**: 实现文本改写功能
- **核心方法**:
  - `getSelectedText()`: 获取选中的网页文本
  - `rewriteText()`: 调用AI模型改写文本
  - `saveRewriteResult()`: 保存改写结果
  - `copyToClipboard()`: 复制文本到剪贴板
  - `loadRewriteHistory()`: 加载改写历史记录
  - `editRewriteHistory()`: 编辑改写历史记录
  - `deleteRewriteHistory()`: 删除改写历史记录
  - `selectModelConfig()`: 选择合适的大模型配置

#### 3.1.2 内容脚本模块
- **功能**: 与网页内容交互
- **核心方法**:
  - `getSelectedText()`: 获取用户选中的文本
  - `highlightText()`: 高亮显示选中文本

### 3.2 后台服务模块

#### 3.2.1 大模型服务
- **功能**: 与AI大模型API交互
- **核心方法**:
  - `callAI()`: 调用AI模型接口
  - `getModelConfig()`: 获取模型配置
  - `validateConfig()`: 验证模型配置

#### 3.2.2 存储服务
- **功能**: 管理插件数据存储
- **核心方法**:
  - `saveData()`: 保存数据到Chrome Storage
  - `loadData()`: 从Chrome Storage加载数据
  - `deleteData()`: 从Chrome Storage删除数据

### 3.3 工具模块

#### 3.3.1 错误处理
- **功能**: 统一错误处理机制
- **核心方法**:
  - `handleError()`: 处理错误信息
  - `showErrorMessage()`: 显示错误消息给用户

#### 3.3.2 重试管理
- **功能**: API调用重试机制
- **核心方法**:
  - `retry()`: 重试函数

#### 3.3.3 加密工具
- **功能**: 敏感信息加密处理
- **核心方法**:
  - `encrypt()`: 加密数据
  - `decrypt()`: 解密数据

---

## 4. 接口设计

### 4.1 大模型API接口

#### Qwen API
- **Base URL**: `https://dashscope.aliyuncs.com/compatible-mode/v1`
- **认证方式**: Bearer Token (API Key)
- **请求方法**: POST
- **请求路径**: `/chat/completions`

#### DeepSeek API
- **Base URL**: `https://api.deepseek.com/v1`
- **认证方式**: Bearer Token (API Key)
- **请求方法**: POST
- **请求路径**: `/chat/completions`

### 4.2 Chrome Extension API

#### Storage API
- `chrome.storage.local.set()`: 保存数据
- `chrome.storage.local.get()`: 获取数据
- `chrome.storage.local.remove()`: 删除数据
- `chrome.storage.local.clear()`: 清空所有数据

#### SidePanel API
- `chrome.sidePanel.setOptions()`: 设置侧边栏选项
- `chrome.sidePanel.onPanelShown`: 侧边栏显示事件

---

## 5. 数据结构设计

### 5.1 大模型配置数据结构

```javascript
{
  id: "unique-id",
  name: "配置名称",
  modelType: "Qwen|DeepSeek",
  apiKey: "加密后的API密钥",
  baseUrl: "API基础URL",
  modelEndpoint: "模型端点",
  createdAt: "创建时间",
  updatedAt: "更新时间"
}
```

### 5.2 改写工作记录数据结构

``javascript
{
  id: "unique-id",
  name: "改写工作名称",
  originalText: "原始文本",
  rewritePrompt: "改写提示词",
  rewriteResult: "改写结果",
  modelConfigId: "使用的大模型配置ID",
  sourceUrl: "原文所属网页URL",
  sourceTitle: "原文所属网页标题",
  createdAt: "创建时间",
  updatedAt: "更新时间"
}
```

---

## 6. 安全设计

### 6.1 数据加密
- API密钥等敏感信息使用加密算法存储
- 使用Chrome Storage API的安全存储机制

### 6.2 通信安全
- 所有API调用使用HTTPS协议
- 验证API响应的有效性

### 6.3 权限控制
- 最小化插件权限申请
- 仅申请必要的Chrome API权限

---

## 7. 性能优化

### 7.1 缓存策略
- 缓存大模型配置信息
- 缓存常用的改写结果

### 7.2 异步处理
- 所有网络请求使用异步处理
- 避免阻塞UI线程

### 7.3 资源管理
- 及时释放不需要的资源
- 优化图片和静态资源大小

---

## 8. 错误处理

### 8.1 网络错误
- 处理网络连接超时
- 处理API服务不可用

### 8.2 数据错误
- 验证用户输入数据
- 处理数据格式不正确的情况

### 8.3 用户提示
- 提供友好的错误提示信息
- 指导用户如何解决问题

---

## 9. 测试策略

### 9.1 单元测试
- 测试核心功能模块
- 验证数据处理逻辑

### 9.2 集成测试
- 测试模块间交互
- 验证API调用流程

### 9.3 用户验收测试
- 验证功能符合需求
- 确保用户体验良好

---

## 10. 部署与发布

### 10.1 构建流程
1. 使用Webpack打包源代码
2. 生成生产环境版本
3. 压缩静态资源文件

### 10.2 发布流程
1. 更新版本号
2. 打包插件文件
3. 提交到Chrome Web Store

---

**文档维护**: 本文档记录FlowFocus插件的技术架构设计，后续版本更新时需同步更新此文档。