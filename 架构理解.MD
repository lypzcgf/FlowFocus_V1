# FlowFocus V2 架构理解

## 概览
- 类型：Chrome 扩展（Manifest v3），提供侧边栏 UI、内容脚本与后台服务三层协作
- 目标：管理“大模型配置”和“改写记录”，并支持与多维表格平台同步
- 关键模块：后台服务、内容脚本、侧边栏 UI、服务层（模型、表格、同步、存储、映射）、适配器层（平台/模型）、工具与常量、构建与测试

## 运行时架构
- 后台服务（Service Worker）
  - 入口与权限：`manifest.json:18-23`
  - 消息处理：文本改写与连接测试 `src/background/background.js:8-25`、`src/background/background.js:44-66`、`src/background/background.js:73-85`
  - 与侧边栏交互：点击扩展图标打开侧边栏 `src/background/background.js:27-37`
- 内容脚本
  - 选区获取与消息路由：`src/content/content.js:72-80`、`src/content/content.js:201-230`
  - 稳健性与错误处理：`src/content/content.js:8-29`
- 侧边栏 UI
  - 页面结构：`src/sidebar/sidebar.html:12-17`、`src/sidebar/sidebar.html:69-121`、`src/sidebar/sidebar.html:124-183`
  - 配置保存/测试/列表渲染：`src/sidebar/sidebar.js:300-372`、`src/sidebar/sidebar.js:375-416`、`src/sidebar/sidebar.js:418-488`

## 服务层设计
- 存储服务（Chrome Storage）
  - 基础 CRUD：`src/services/storageService.js:13-26`、`src/services/storageService.js:33-42`、`src/services/storageService.js:50-59`
  - 模型配置：保存/加载/删除/查找 `src/services/storageService.js:93-121`、`src/services/storageService.js:128-136`、`src/services/storageService.js:143-151`、`src/services/storageService.js:175-183`
  - 改写记录：保存/加载/删除/查找 `src/services/storageService.js:191-220`、`src/services/storageService.js:226-234`、`src/services/storageService.js:241-249`、`src/services/storageService.js:273-281`
  - 多维表格配置：`src/services/storageService.js:312-340`、`src/services/storageService.js:347-355`、`src/services/storageService.js:362-371`、`src/services/storageService.js:378-386`
- 模型服务
  - 适配器工厂驱动模型调用：`src/services/modelService.js:28-39`、`src/services/adapters/modelAdapterFactory.js:94-126`
  - 测试连接与改写：`src/services/modelService.js:64-87`、`src/services/modelService.js:97-123`
  - 性能指标记录：`src/services/modelService.js:132-160`
- 表格服务
  - 统一 CRUD API，按平台派发到适配器：`src/services/tableService.js:20-31`、`src/services/tableService.js:38-45`、`src/services/tableService.js:53-60`
- 同步服务
  - 单条/批量/全量：`src/services/syncService.js:83-157`、`src/services/syncService.js:225-316`、`src/services/syncService.js:359-400`
  - 重试与熔断、并发与策略：`src/services/syncService.js:167-216`、`src/services/syncService.js:24-47`
- 数据映射
  - 序列化与反序列化：`src/services/dataMapper.js:15-101`、`src/services/dataMapper.js:108-134`
  - 跨平台转换与压缩：`src/services/dataMapper.js:246-286`、`src/services/dataMapper.js:301-334`

## 适配器层
- 平台适配器基类
  - 统一请求、重试、认证头：`src/services/adapters/baseAdapter.js:75-117`、`src/services/adapters/baseAdapter.js:149-153`
- 飞书适配器（示例最完整）
  - 批量操作：`src/services/adapters/feishuAdapter.js:44-67`、`src/services/adapters/feishuAdapter.js:74-98`、`src/services/adapters/feishuAdapter.js:105-130`
  - 令牌管理与速率限制：`src/services/adapters/feishuAdapter.js:136-191`、`src/services/adapters/feishuAdapter.js:209-234`
- 大模型适配器基类
  - 构建请求与重试：`src/services/adapters/baseModelAdapter.js:53-61`、`src/services/adapters/baseModelAdapter.js:70-87`
  - 连接测试与改写：`src/services/adapters/baseModelAdapter.js:105-144`、`src/services/adapters/baseModelAdapter.js:153-176`
- 模型适配器工厂
  - 支持 Qwen/DeepSeek/Volces/Kimi/Hunyuan：`src/services/adapters/modelAdapterFactory.js:96-102`

## 常量与模型
- 常量：模型/平台/状态/配置等统一定义 `src/utils/constants.js:15-60`、`src/utils/constants.js:70-92`、`src/utils/constants.js:202-214`
- 数据模型：`src/models/configModels.js:9-24`、`src/models/configModels.js:30-49`、`src/models/configModels.js:137-171`

## 错误与性能
- 全局错误处理：`src/utils/errorHandler.js:48-62`、`src/utils/errorHandler.js:65-77`
- 性能监控：计时与阈值、日志与事件 `src/services/performanceMonitor.js:49-61`、`src/services/performanceMonitor.js:70-112`、`src/services/performanceMonitor.js:327-335`
- 内存优化：缓存/事件/定时器/对象池 `src/utils/memoryOptimizer.js:32-63`、`src/utils/memoryOptimizer.js:83-114`、`src/utils/memoryOptimizer.js:116-136`

## 构建与发布
- 入口与输出：`webpack.config.js:6-16`
- 资源与页面生成：`webpack.config.js:42-69`
- 脚本：`package.json:6-15`（`build`、`dev`、`package`、`lint`、`test`）
- Manifest 页面/脚本挂载：`manifest.json:21-29`

## 典型交互流程
- 文本改写
  1. 侧边栏收集模型配置与文本，触发测试或改写 `src/sidebar/sidebar.js:375-416`
  2. 后台路由消息到模型服务 `src/background/background.js:12-21`、`src/background/background.js:44-66`
  3. 适配器发送请求并返回改写内容 `src/services/adapters/baseModelAdapter.js:153-168`
  4. 结果在侧边栏呈现并可保存为改写记录 `src/services/storageService.js:191-220`
- 同步到多维表格
  1. 侧边栏选择记录或配置并触发同步 `src/sidebar/sidebar.html:172-177`
  2. 同步服务序列化数据并调用表格服务 `src/services/dataMapper.js:15-101`、`src/services/tableService.js:38-45`
  3. 平台适配器执行批量/单条写入 `src/services/adapters/feishuAdapter.js:44-67`

## 扩展与演进
- 新增模型类型
  - 实现新适配器继承 `BaseModelAdapter`，在工厂映射注册 `src/services/adapters/modelAdapterFactory.js:271-277`
- 新增多维表格平台
  - 实现新平台适配器继承 `BaseAdapter`，在 `TableService.createAdapter` 扩展 `src/services/tableService.js:20-31`
- 性能与稳定性
  - 使用性能监控计时 `src/services/performanceMonitor.js:49-61`，根据阈值告警 `src/services/performanceMonitor.js:327-335`
  - 同步策略/并发/退避重试 `src/services/syncService.js:24-47`、`src/services/syncService.js:167-216`

## 安全与合规
- API Key 存储于 `chrome.storage.local`，建议最小化暴露并按需加密 `src/services/storageService.js:93-121`、`src/utils/utils.js:60-75`
- 不将构建产物与敏感文件入库，已通过 `.gitignore` 管理

## 测试
- 测试框架：Jest（含 jsdom 环境）`package.json:9`、`tests/setup.js`
- 可编写集成测试覆盖模型调用与同步逻辑（示例位于 `tests/`）

## 开发者指南（速记）
- 启动开发：`npm run dev`（监听并输出到 `dist/`）
- 单次构建：`npm run build`
- 本地打包：`npm run package`
- 加载扩展：Chrome 打开 `chrome://extensions/`，加载 `dist/`

---
> 本文侧重“架构-模块-交互-演进”的纵览，细节以源码为准，上文的代码位置索引可快速跳转到关键实现处。